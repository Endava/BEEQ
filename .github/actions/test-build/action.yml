name: Test & Build
description: Run linters and unit tests, build the project and finally check all E2E tests within the NX Cloud Agent.

runs:
  using: composite
  steps:
    - name: ğŸ•µï¸â€â™€ï¸ Derive appropriate SHAs for base and head for `nx affected` commands
      uses: nrwl/nx-set-shas@v3

    - name: ğŸ‘®ğŸ¼â€â™€ï¸ Start NX Cloud Agent
      run: npx nx-cloud start-ci-run
      shell: bash

    - name: ğŸ©º Run Linters and Unit Tests
      run: npx nx affected --target=test --exclude=workspace --output-style=stream-without-prefixes -- --ci --code-coverage --runInBand
      shell: bash

    - name: â³ Build
      run: npx nx run bee-q:storybook-build --output-style=stream-without-prefixes
      shell: bash

    - name: ğŸ§ª Run E2E Tests (only affected)
      run: npx nx affected --target=e2e --exclude=workspace --output-style=stream-without-prefixes -- --ci --code-coverage --runInBand
      shell: bash

    - name: ğŸ“´ Stop NX Cloud Agent
      run: npx nx-cloud stop-all-agents
      shell: bash
